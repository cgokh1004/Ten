<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="survey">

<resultMap type="SurveyDTO" id="SurveyDTOResultMap">
   <result property="sulno" column="sulno"/>
   <result property="askcontent" column="askcontent"/>
   <result property="sulgroupname" column="sulgroupname"/>  
   <collection property="sulmunrList" column="sulno" javaType="List" ofType="SulmunrDTO"
   resultMap="survey.SulmunrDTOResultMap"/> 
</resultMap>
<resultMap type="SulmunrDTO" id="SulmunrDTOResultMap">
 <result property="sulmunrno" column="sulmunrno"/>
 <result property="chono" column="chono"/>
 <result property="chocontent" column="chocontent"/>
 <result property="sulno" column="sulno"/>
</resultMap>

<!-- 1. insert -->
	<insert id="create" parameterType="SurveyDTO">
	INSERT INTO survey(sulno, askcontent ,  sulgroupname )
	VALUES((SELECT NVL(MAX(sulno), 0) + 1 as sulno FROM survey), #{askcontent}, #{sulgroupname})
	</insert>
<!-- 2.update -->
	<update id="update" parameterType="SurveyDTO">
	 UPDATE survey SET askcontent = #{askcontent} WHERE sulno=#{sulno}
	</update>
<!-- 3.read -->	
   <select id="oneToMany" parameterType="int" resultMap="SurveyDTOResultMap">  
   select survey.sulno, survey.askcontent, sulmunr.chono, sulmunr.chocontent
   from survey join sulmunr  on survey.sulno = sulmunr.sulno
  where survey.sulno =#{sulno}
  order by sulmunr.chono asc     
  
  
  </select>  
  
<!-- 4.delete -->  
  <delete id="delete" parameterType="int">
DELETE FROM survey WHERE sulno = #{sulno}
</delete>

<!-- 5.total -->
	<select id="total" parameterType="Map" resultType="int">
		select count(*) from survey
		<where>
			<choose>
				<when test="col=='askcontent'">
					askcontent LIKE '%' || #{word} || '%'
				</when>				
			</choose>
		</where>
	</select>
<!-- 6.list -->
   <select id="list" parameterType="Map" resultType="int">
   
<!--    select sulgroupname from survey group by sulgroupname      -->
   
    select sulno, askcontent, r 
  FROM(
       select sulno, askcontent, rownum r 
       FROM(
            select sulno, askcontent 
            from survey
            
	<where>
			<choose>
				<when test="col=='askcontent'">
					askcontent LIKE '%' || #{word} || '%'
				</when>				
			</choose>
		</where>
			ORDER BY sulno asc

		)
		)                                                                            
   <![CDATA[                                                                        
   where r>=#{sno} and r<=#{eno}  
    ]]> 
	</select>
 
</mapper>
 